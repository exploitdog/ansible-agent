{{ ansible_managed | comment }}
description "Exploitdog Agent"
start on (local-filesystems and net-device-up IFACE!=lo)
stop on runlevel [016]

respawn
respawn limit 10 5
env AGENT_TOKEN={{ exploitdog_agent_token }}
env AGENT_HOST_ID={{ ansible_product_uuid.lower() }}
{% if exploitdog_agent_upstart_version | int >= 1.4 %}
setuid {{ _exploitdog_agent_system_user }}
setgid {{ _exploitdog_agent_system_group }}
{% endif %}

exec \
{% if exploitdog_agent_upstart_version | int < 1.4 %}
su -s /bin/sh -c 'exec "$0" "$@"' {{ _exploitdog_agent_system_user }} -- \
{% endif %}
{{ _exploitdog_agent_binary_install_dir }}/exploitdog_agent \
{% for collector in exploitdog_agent_enabled_collectors %}
    --collector.{{ collector }} \
{% endfor %}
{% for collector in exploitdog_agent_disabled_collectors %}
    --no-collector.{{ collector }} \
{% endfor %}
{% if exploitdog_agent_duration %}
    --duration={{ exploitdog_agent_duration }} \
{% endif %}
{% if exploitdog_agent_proxy %}
    --proxy={{ exploitdog_agent_proxy }} \
{% endif %}
{% if exploitdog_agent_url %}
    --url={{ exploitdog_agent_url }}
{% endif %}