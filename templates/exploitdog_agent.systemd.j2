{{ ansible_managed | comment }}

[Unit]
Description=Exploitdog Agent
After=network-online.target

[Service]
Type=simple
User={{ _exploitdog_agent_system_user }}
Group={{ _exploitdog_agent_system_group }}
Environment="AGENT_TOKEN={{ exploitdog_agent_token }}"
ExecStart={{ _exploitdog_agent_binary_install_dir }}/exploitdog_agent \
{% for collector in exploitdog_agent_enabled_collectors %}
    --collector.{{ collector }} \
{% endfor %}
{% for collector in exploitdog_agent_disabled_collectors %}
    --no-collector.{{ collector }} \
{% endfor %}
{% if exploitdog_agent_duration %}
    --duration={{ exploitdog_agent_duration }} \
{% endif %}
{% if exploitdog_agent_proxy %}
    --proxy={{ exploitdog_agent_proxy }} \
{% endif %}
{% if exploitdog_agent_url %}
    --url={{ exploitdog_agent_url }}
{% endif %}

SyslogIdentifier=exploitdog_agent
Restart=always
RestartSec=1
StartLimitInterval=0

{% if exploitdog_agent_systemd_version | int >= 232 %}
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelTunables=yes
{% else %}
ProtectSystem=full
{% endif %}

[Install]
WantedBy=multi-user.target